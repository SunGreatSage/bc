# 系统会员体系与注册机制分析报告

> 生成时间：2025-11-10
> 分析文件：`uxj/reg.php`, `mxj/reg.php`, `hide/suser.php`, `agent/suser.php`
> 分析者：Claude AI

---

## 目录

- [一、注册页面和接口](#一注册页面和接口)
- [二、注册流程分析](#二注册流程分析)
- [三、后台添加用户/代理](#三后台添加用户代理)
- [四、核心机制对比](#四核心机制对比)
- [五、重要发现](#五重要发现)
- [六、数据库字段说明](#六数据库字段说明)
- [七、安全风险与建议](#七安全风险与建议)
- [八、总结](#八总结)

---

## 一、注册页面和接口

### ✅ 系统存在前台注册功能

系统提供了 **3 个注册页面入口**：

| 入口类型 | 文件路径 | 设备适配 | 状态 |
|---------|---------|---------|------|
| **PC 端注册** | `uxj/reg.php` | 桌面浏览器 | ✅ 可用 |
| **移动端注册** | `mxj/reg.php` | 手机/平板 | ✅ 可用 |
| **主注册入口** | `main/reg.php` | 通用 | ✅ 可用 |

**访问示例**：
- PC端：`http://domain/uxj/reg.php`
- 移动端：`http://domain/mxj/reg.php`
- 带推荐人：`http://domain/uxj/reg.php?agent=ADMIN123`

---

## 二、注册流程分析

### 🔹 前台自助注册流程

#### 1. 注册表单字段

| 字段名 | 必填 | 验证规则 | 说明 |
|-------|------|---------|------|
| 推荐人账号 (`agent`) | ❌ 否 | 字母数字组合 | 如果不填，系统使用默认代理 |
| 用户名 (`username`) | ✅ 是 | 3-8位字母数字 | 自动转大写 |
| 登录密码 (`password`) | ✅ 是 | 6-15位字符 | MD5 加密 + salt |
| 真实姓名 (`name`) | ✅ 是 | 非空 | 必须与银行卡姓名一致 |
| 手机号码 (`tel`) | ✅ 是 | 纯数字 | 用于账户找回 |
| QQ号 (`qq`) | ✅ 是 | 纯数字 | 联系方式 |
| 验证码 (`code`) | ✅ 是 | 4位数字/字母 | 防机器注册 |

#### 2. 注册处理逻辑 (`uxj/reg.php:8-109`)

```php
// 第一步：验证推荐人
if ($agent != '') {
    // 检查推荐人是否存在
    $msql->query("select username from `$tb_user` where username='$agent' and wid='$wid'");
    if (推荐人不存在) {
        alert('推荐人不存在!');
        exit;
    }
    $trueagent = $agent;
} else {
    // 使用系统默认代理（从 x_web 表获取）
    $msql->query("select username from `$tb_user`
                  where username=(select zcagent from `$tb_web` where wid='$wid')");
    $trueagent = 默认代理;
}

// 第二步：创建用户记录
INSERT INTO x_user SET
    username = '$username',
    userid = '新8位ID',              // setupid() 函数生成
    userpass = 'MD5(MD5(password) + "puhh8kik")',  // 双重加密
    name = '$name',
    tname = '$name',
    tel = '$tel',
    qq = '$qq',
    status = '1',                    // 账户启用
    ifagent = '1',                   // ⚠️ 重点：所有注册用户默认可以成为代理！
    layer = '推荐人layer + 1',       // 层级递增
    maxren = '0',                    // 可开会员数为0（需要管理员授权）
    plc = '0',                       // 不参与占成
    pan = '推荐人pan',               // 继承盘口设置
    defaultpan = '推荐人defaultpan',
    maxmoney = '0',                  // 低频彩初始额度为0
    kmaxmoney = '0',                 // 快开彩初始额度为0
    money = '0',
    kmoney = '0',
    fudong = '1',                    // 现金模式
    fid = '推荐人userid',             // 上级ID
    wid = '站点ID',
    gid = '游戏ID',
    regtime = NOW(),
    liushui = 0;

// 第三步：设置上级层级关系（最多支持8层）
for ($j = ($layer - 2); $j >= 1; $j--) {
    $sql .= ",fid" . $j . "='" . $msql->f('fid' . $j) . "'";
}
$sql .= ",fid".($layer-1)."='".$fid."'";
```

#### 3. 注册后初始化操作

注册成功后，系统会自动执行以下操作：

| 操作 | SQL语句 | 说明 |
|------|---------|------|
| 1. 记录注册日志 | `INSERT INTO x_user_edit` | 记录注册IP、时间 |
| 2. 复制快捷金额 | `INSERT INTO x_fastje SELECT ... FROM x_fastje WHERE userid='99999999'` | 复制系统默认快捷金额 |
| 3. 复制占成设置 | `INSERT INTO x_zpan SELECT ... WHERE userid='$fid'` | 继承推荐人占成设置 |
| 4. 复制返点设置 | `INSERT INTO x_points SELECT ... WHERE userid='$fid'` | 继承推荐人返点（如果是自填推荐人）<br>清零返点（如果是默认代理） |
| 5. 复制游戏配置 | `insertgame($gamecs, $uid)` | 继承推荐人的游戏权限 |

**注意**：如果用户不填推荐人（使用系统默认代理），返点会被清零：

```php
if($ifa==0){  // $ifa=0 表示使用默认代理
    // 返点清零
    $msql->query("insert into `$tb_points` select NULL,gid,$uid,class,ab,0,0,0,0,cmaxje,maxje,minje from `$tb_points` where userid='$fid'");
} else {
    // 继承推荐人返点
    $msql->query("insert into `$tb_points` select NULL,gid,$uid,class,ab,a,b,c,d,cmaxje,maxje,minje from `$tb_points` where userid='$fid'");
}
```

---

## 三、后台添加用户/代理

### 🔹 管理员后台添加 (`hide/suser.php`)

**访问路径**：管理员后台 → 用户管理 → 新增用户

**功能位置**：`hide/suser.php` case "adduser" (第514-663行)

#### 可设置的高级参数

| 参数 | 前台注册 | 后台添加 | 说明 |
|------|----------|----------|------|
| 用户名 | ✅ | ✅ | 3-32位字母数字 |
| 密码 | ✅ | ✅ | MD5加密 |
| 真实姓名 | ✅ | ✅ | - |
| 联系方式 | ✅ | ✅ | 电话、QQ |
| **低频彩额度** (`maxmoney`) | ❌ 固定0 | ✅ 可设置 | 传统彩票额度 |
| **快开彩额度** (`kmaxmoney`) | ❌ 固定0 | ✅ 可设置 | 快开彩票额度 |
| **是否代理** (`ifagent`) | ✅ 固定1 | ✅ 可选 | 0=普通用户,1=代理 |
| **账户状态** (`status`) | ✅ 固定1 | ✅ 可选 | 0=禁用,1=正常 |
| **占成模式** (`plc`) | ❌ 固定0 | ✅ 可设置 | 是否参与占成 |
| **浮动模式** (`fudong`) | ✅ 固定1 | ✅ 可选 | 0=信用模式,1=现金模式 |
| **可开会员数** (`maxren`) | ❌ 固定0 | ✅ 可设置 | 可发展下级数量 |
| **返点设置** (`liushui`) | ❌ 继承上级 | ✅ 可调整 | 用户返点比例 |
| **自行执行** (`ifexe`) | ❌ 继承 | ✅ 可设置 | 是否可自行修改赔率 |
| **自占自落** (`pself`) | ❌ 继承 | ✅ 可设置 | 是否自己占成自己的下级 |

#### 后台添加的特殊功能

```php
// 1. 现金模式：直接从上级账户扣款
if ($fudong == 1 && $thefid != 99999999) {
    $msql->query("update `$tb_user`
                  set kmaxmoney=kmaxmoney-$kmoney,
                      kmoney=kmoney-$kmoney
                  where userid='$thefid'");
    usermoneylog($thefid, 0-$kmaxmoney, $kmaxmoneys - $kmaxmoney, '新增用户充值-'.$username);
}

// 2. 信用模式：不扣上级账户
else {
    userchange("新增,低频彩额度$maxmoney,快开彩额度$kmaxmoney,", $uid);
}

// 3. 返点设置（可调整）
if($liushui=='all'){
    // 完全继承上级返点
    $msql->query("insert into `$tb_points` select NULL,gid,$uid,class,ab,0,0,0,0,cmaxje,maxje,minje from `$tb_points` where userid='$thefid'");
} else {
    // 在上级基础上扣减 $liushui
    $msql->query("insert into `$tb_points`
                  select NULL,gid,$uid,class,ab,
                         if(a-$liushui<0,0,a-$liushui),
                         if(b-$liushui<0,0,b-$liushui),
                         if(c-$liushui<0,0,c-$liushui),
                         if(d-$liushui<0,0,d-$liushui),
                         cmaxje,maxje,minje
                  from `$tb_points` where userid='$thefid'");
}
```

### 🔹 代理后台添加 (`agent/suser.php`)

**访问路径**：代理后台 → 会员管理 → 新增会员

**权限限制**：
1. ✅ 只能添加自己的下级用户
2. ✅ 不能超过自己的可开会员数 (`maxren`)
3. ✅ 额度不能超过自己的剩余额度
4. ✅ 返点不能超过自己的返点

**代码示例**：
```php
// 检查可开会员数
$maxrens = getmaxren($fid);
if ($maxren > $maxrens) {
    echo "可用会员数不足!";
    exit;
}

// 检查额度限制
$kmaxmoneys = getkmaxmoney($fid);
if ($kmaxmoney > $kmaxmoneys) {
    $kmaxmoney = $kmaxmoneys;
}
```

---

## 四、核心机制对比

### 📊 前台注册 vs 后台添加

| 对比项 | 前台自助注册 | 后台管理员添加 | 后台代理添加 |
|-------|-------------|--------------|------------|
| **访问入口** | uxj/reg.php, mxj/reg.php | hide/suser.php | agent/suser.php |
| **注册权限** | 公开（任何人） | 管理员 | 代理商 |
| **推荐人** | 可选（用户填写） | 可选（管理员指定） | 固定（自己） |
| **初始额度** | 0元（需充值） | 可设置任意额度 | 受限于自身额度 |
| **ifagent字段** | **强制=1（都是代理）** | 可选0或1 | 可选0或1 |
| **layer层级** | 自动递增 | 自动递增 | 自动递增 |
| **maxren可开数** | 固定0 | 可设置 | 受限于自身剩余数 |
| **返点设置** | 继承推荐人（或清零） | 可自定义调整 | 不能超过自己 |
| **验证码** | ✅ 需要 | ❌ 不需要 | ❌ 不需要 |
| **审核机制** | ❌ 立即生效 | ❌ 立即生效 | ❌ 立即生效 |
| **扣款方式** | 无（额度为0） | 可选扣/不扣上级 | 必须扣自己 |

---

## 五、重要发现

### 🔴 发现 1：所有前台注册用户都是代理！

**问题代码**：`uxj/reg.php:76` 和 `mxj/reg.php:111`

```php
$sql = "insert into `$tb_user` set
    ...
    ifagent='1',  // ← 硬编码固定设为1，表示是代理
    layer='$layer',
    maxren='0',   // ← 但可开会员数为0，需要管理员后续授权
    ...
```

**实际影响**：

✅ **好处**：
- 所有用户都能发展下线（符合彩票推广业务模型）
- 用户注册后可以分享推荐链接拉新

⚠️ **风险**：
- 即使设置 `maxren=0`，用户仍可能通过代理功能访问代理后台
- 可能被恶意利用建立多层代理关系
- 增加了系统复杂度（所有用户都有代理权限）

**修复建议**：

```php
// 方案1：默认为普通用户，提供"申请代理"功能
$ifagent = '0';  // 改为0

// 方案2：通过配置控制
$ifagent = $config['reg_default_agent'] ? '1' : '0';

// 方案3：区分注册类型
if ($_POST['reg_type'] == 'agent') {
    $ifagent = '1';
} else {
    $ifagent = '0';
}
```

---

### 🟡 发现 2：推荐人机制的双重标准

**如果用户填写推荐人**：
1. ✅ 推荐人必须在同一站点 (`wid` 相同)
2. ✅ 新用户的上级 (`fid`) = 推荐人ID
3. ✅ **继承推荐人的完整返点设置**

**如果用户不填推荐人**：
1. ✅ 使用系统默认代理（`x_web.zcagent` 字段）
2. ⚠️ **返点设置被清零**（`$ifa=0`）

**代码位置**：`uxj/reg.php:50-58` 和 `mxj/reg.php:85-93`

```php
if($trueagent==''){
    // 使用默认代理
    $msql->query("select username from `$tb_user`
                  where username=(select zcagent from `$tb_web` where wid='$wid')");
    $trueagent = $msql->f('username');
    $ifa=0;  // ← 标记为默认代理，导致返点清零
}

// 后续判断
if($ifa==0){
    // 返点清零：a=0, b=0, c=0, d=0
    $msql->query("insert into `$tb_points`
                  select NULL,gid,$uid,class,ab,0,0,0,0,cmaxje,maxje,minje
                  from `$tb_points` where userid='$fid'");
} else {
    // 完整继承：a, b, c, d
    $msql->query("insert into `$tb_points`
                  select NULL,gid,$uid,class,ab,a,b,c,d,cmaxje,maxje,minje
                  from `$tb_points` where userid='$fid'");
}
```

**业务逻辑分析**：
- 目的：鼓励用户填写真实推荐人（通过差异化返点激励）
- 风险：用户可能不知道这个差异，导致不公平

---

### 🟢 发现 3：密码加密机制

**加密方式**：双重 MD5 + 固定 salt

```php
// 第一次加密
$userpass = md5($password);

// 第二次加密（添加固定salt）
$userpass = md5($userpass . "puhh8kik");
```

**完整加密示例**：
```
原始密码：123456
第一次MD5：e10adc3949ba59abbe56e057f20f883e
拼接salt：e10adc3949ba59abbe56e057f20f883epuhh8kik
第二次MD5：[存储到数据库的最终值]
```

**安全评估**：

✅ **优点**：
- 比单次 MD5 安全
- 防止彩虹表直接破解

⚠️ **缺点**：
- 固定 salt 存在风险（所有用户使用相同 salt）
- MD5 算法已被证明存在碰撞攻击

❌ **高风险**：
- 如果 salt "puhh8kik" 泄露，攻击者可以预先生成彩虹表
- MD5 计算速度快，暴力破解成本低

**建议改进**：

```php
// 方案1：使用 bcrypt（推荐）
$userpass = password_hash($password, PASSWORD_BCRYPT, ['cost' => 12]);

// 方案2：使用随机 salt + SHA256
$salt = bin2hex(random_bytes(16));  // 随机32位salt
$userpass = hash('sha256', $password . $salt);
// 需要同时存储 $userpass 和 $salt
```

---

### 🔵 发现 4：层级体系的深度限制

**层级字段设计**：

```sql
-- x_user 表字段
layer INT          -- 当前层级（1,2,3...）
fid VARCHAR(8)     -- 上级ID
fid1 VARCHAR(8)    -- 第1层上级ID
fid2 VARCHAR(8)    -- 第2层上级ID
fid3 VARCHAR(8)    -- 第3层上级ID
fid4 VARCHAR(8)    -- 第4层上级ID
fid5 VARCHAR(8)    -- 第5层上级ID
fid6 VARCHAR(8)    -- 第6层上级ID
fid7 VARCHAR(8)    -- 第7层上级ID
fid8 VARCHAR(8)    -- 第8层上级ID（最深）
```

**代码实现**：`uxj/reg.php:77-80`

```php
// 设置上级层级关系
for ($j = ($layer - 2); $j >= 1; $j--) {
    $sql .= ",fid" . $j . "='" . $msql->f('fid' . $j) . "'";
}
$sql .= ",fid".($layer-1)."='".$fid."'";
```

**层级示例**：

```
第1层（顶级）：99999999 (系统账户)
├─ 第2层：AGENT001 (总代理)
   ├─ 第3层：AGENT101 (一级代理)
      ├─ 第4层：USER001 (用户)
         ├─ 第5层：USER101 (下级用户)
            └─ ...最多到第9层
```

**限制说明**：
- ✅ 最大深度：9 层（fid1~fid8 + layer）
- ⚠️ 超过9层后无法继续发展下级
- ⚠️ 需要在代码中增加层级检查

---

## 六、数据库字段说明

### x_user 表关键字段详解

| 字段名 | 类型 | 默认值 | 前台注册 | 后台添加 | 说明 |
|-------|------|--------|----------|----------|------|
| `userid` | VARCHAR(8) | 自动生成 | ✅ | ✅ | 用户唯一ID（setupid生成） |
| `username` | VARCHAR(32) | - | ✅ | ✅ | 登录用户名（自动转大写） |
| `userpass` | VARCHAR(32) | - | ✅ | ✅ | 密码（双重MD5加密） |
| `name` | VARCHAR(50) | - | ✅ | ✅ | 真实姓名（用于提款验证） |
| `tname` | VARCHAR(50) | = name | ✅ | ✅ | 姓名备份字段 |
| `tel` | VARCHAR(20) | - | ✅ | ✅ | 手机号码 |
| `qq` | VARCHAR(30) | - | ✅ | ✅ | QQ号 |
| `sex` | TINYINT(1) | 0 | ❌ | ✅ | 性别（0=保密,1=男,2=女） |
| `birthday` | DATE | NULL | ❌ | ✅ | 生日 |
| `ifagent` | TINYINT(1) | **1** | ✅ 固定1 | ✅ 可选 | 是否代理（0=否,1=是） |
| `layer` | INT | 上级+1 | ✅ | ✅ | 层级（1=顶级） |
| `maxren` | INT | 0 | ✅ 固定0 | ✅ 可设置 | 可开会员数量 |
| `fid` | VARCHAR(8) | 推荐人ID | ✅ | ✅ | 直属上级用户ID |
| `fid1~fid8` | VARCHAR(8) | 自动填充 | ✅ | ✅ | 各层级上级ID |
| `wid` | INT | 站点ID | ✅ | ✅ | 所属站点ID |
| `gid` | INT | 游戏ID | ✅ | ✅ | 默认游戏ID |
| `status` | TINYINT(1) | 1 | ✅ 固定1 | ✅ 可选 | 账户状态（0=禁用,1=正常） |
| `fudong` | TINYINT(1) | 1 | ✅ 固定1 | ✅ 可选 | 0=信用模式,1=现金模式 |
| `maxmoney` | DECIMAL(10,2) | 0 | ✅ 固定0 | ✅ 可设置 | 低频彩额度 |
| `kmaxmoney` | DECIMAL(10,2) | 0 | ✅ 固定0 | ✅ 可设置 | 快开彩额度 |
| `money` | DECIMAL(10,2) | 0 | ✅ | ✅ | 低频彩当前余额 |
| `kmoney` | DECIMAL(10,2) | 0 | ✅ | ✅ | 快开彩当前余额 |
| `plc` | DECIMAL(4,2) | 0 | ✅ 固定0 | ✅ 可设置 | 占成比例 |
| `ifexe` | TINYINT(1) | 继承 | ✅ | ✅ | 是否可自行修改赔率 |
| `pself` | TINYINT(1) | 继承 | ✅ | ✅ | 是否自占自落 |
| `pan` | VARCHAR(50) | 继承 | ✅ | ✅ | 可用盘口（JSON数组） |
| `defaultpan` | VARCHAR(10) | 继承 | ✅ | ✅ | 默认盘口 |
| `liushui` | DECIMAL(4,2) | 0 | ✅ | ✅ | 流水要求 |
| `regtime` | DATETIME | NOW() | ✅ | ✅ | 注册时间 |
| `ftime` | DATETIME | 计算 | ✅ | ✅ | 浮动结算时间 |

### x_web 表（站点配置）

| 字段名 | 类型 | 说明 |
|-------|------|------|
| `wid` | INT | 站点ID |
| `zcagent` | VARCHAR(32) | 默认注册代理（用户不填推荐人时使用） |
| `guser` | TEXT | 游客账号列表（逗号分隔） |
| `uskin` | VARCHAR(50) | 用户界面皮肤 |

---

## 七、安全风险与建议

### 🔴 高风险问题

#### 1. 所有注册用户都是代理

**风险等级**：🔴 **严重**

**问题描述**：
- 前台注册的用户 `ifagent` 字段硬编码为 `1`
- 即使 `maxren=0`，用户仍能访问代理后台功能

**潜在影响**：
- ❌ 可能被恶意利用发展多层代理
- ❌ 增加系统安全风险
- ❌ 管理复杂度提升

**修复建议**：

```php
// uxj/reg.php:76 修改为
$ifagent = '0';  // 默认为普通用户

// 或增加配置项
$ifagent = $config['allow_reg_agent'] ? '1' : '0';
```

**改进方案**：
1. ✅ 增加"申请成为代理"功能（需要管理员审核）
2. ✅ 区分注册类型（普通用户 / 代理）
3. ✅ 代理注册需要邀请码

---

#### 2. 密码加密强度不足

**风险等级**：🔴 **严重**

**问题描述**：
- 使用 MD5 加密（已被证明不安全）
- 固定 salt "puhh8kik"（所有用户相同）

**潜在影响**：
- ❌ 密码可被彩虹表破解
- ❌ 数据库泄露后所有密码可被反推
- ❌ 暴力破解成本低

**修复建议**：

```php
// 方案1：使用 bcrypt（推荐）
// 注册时
$userpass = password_hash($password, PASSWORD_BCRYPT, ['cost' => 12]);

// 登录验证时
if (password_verify($input_password, $stored_hash)) {
    // 密码正确
}

// 方案2：使用随机salt + SHA256
$salt = bin2hex(random_bytes(16));
$userpass = hash('sha256', $password . $salt);
// 需要同时存储 $userpass 和 $salt
```

**迁移步骤**：
1. ✅ 数据库增加 `password_hash` 字段
2. ✅ 用户下次登录时自动迁移到新加密方式
3. ✅ 设置迁移期限（如3个月）

---

#### 3. 无注册审核机制

**风险等级**：🔴 **严重**

**问题描述**：
- 注册后立即生效，无需审核
- 缺少邮箱/手机验证

**潜在影响**：
- ❌ 批量恶意注册
- ❌ 虚假账号泛滥
- ❌ 无法追溯真实用户

**修复建议**：

```php
// 1. 增加审核状态
INSERT INTO x_user SET
    ...
    status = '0',  // 0=待审核, 1=正常, 2=禁用
    verify_code = '随机验证码',
    verify_expire = DATE_ADD(NOW(), INTERVAL 24 HOUR);

// 2. 发送验证邮件
send_mail($email, "请验证您的账号", "验证码：$verify_code");

// 3. 用户点击链接验证
if ($code == $verify_code && NOW() < $verify_expire) {
    UPDATE x_user SET status='1' WHERE userid='$uid';
}
```

---

### 🟡 中风险问题

#### 4. 缺少注册开关

**风险等级**：🟡 **中等**

**问题描述**：
- 无法临时关闭注册功能
- 遇到攻击时无法快速响应

**修复建议**：

```php
// 在 x_config 表增加配置
allow_register TINYINT(1) DEFAULT 1  -- 是否允许注册

// reg.php 开头增加检查
if ($config['allow_register'] != 1) {
    echo "<script>alert('系统维护中，暂停注册！');</script>";
    exit;
}
```

---

#### 5. 推荐人验证不严格

**风险等级**：🟡 **中等**

**问题描述**：
- 只检查推荐人是否存在
- 不检查推荐人状态（可能已被封禁）
- 不检查推荐人层级（可能已达最大深度）

**修复建议**：

```php
// 增加完整性检查
$msql->query("select username,status,layer,ifagent from `$tb_user`
              where username='$agent' and wid='$wid'");

if ($msql->f('status') != 1) {
    alert('推荐人账户已被禁用！');
    exit;
}

if ($msql->f('layer') >= 8) {
    alert('推荐人层级已达上限，无法继续发展下级！');
    exit;
}

if ($msql->f('ifagent') != 1) {
    alert('该用户不是代理，无法作为推荐人！');
    exit;
}
```

---

#### 6. 缺少注册频率限制

**风险等级**：🟡 **中等**

**问题描述**：
- 同一IP可无限次注册
- 缺少短信验证码

**修复建议**：

```php
// 1. IP频率限制
$ip = getip();
$msql->query("select count(*) as cnt from x_user
              where regtime > DATE_SUB(NOW(), INTERVAL 1 HOUR)
              and regip='$ip'");
if ($msql->f('cnt') >= 3) {
    alert('您的IP注册过于频繁，请1小时后再试！');
    exit;
}

// 2. 增加短信验证
send_sms($tel, "验证码：$code");
if ($_POST['sms_code'] != $_SESSION['sms_code']) {
    alert('短信验证码错误！');
    exit;
}
```

---

### 🟢 低风险问题

#### 7. 验证码可能被绕过

**风险等级**：🟢 **低**

**问题描述**：
- 使用简单的图形验证码
- 可能被 OCR 识别

**修复建议**：
- 升级到 Google reCAPTCHA v3
- 增加滑动验证

---

#### 8. 缺少用户协议确认

**风险等级**：🟢 **低**

**问题描述**：
- 注册时未强制阅读用户协议
- 法律风险

**修复建议**：

```php
// 增加协议字段
agree_terms TINYINT(1) DEFAULT 0

// 注册表单增加复选框
<input type="checkbox" name="agree" value="1" required>
我已阅读并同意《用户协议》
```

---

## 八、总结

### ✅ 系统注册机制特点

#### 1. 用户获取方式（3种）

| 方式 | 入口 | 权限 | 额度 | 状态 |
|------|------|------|------|------|
| **前台自助注册** | PC端：uxj/reg.php<br>移动端：mxj/reg.php | 公开 | 0元 | ✅ 开启 |
| **管理员后台添加** | hide/suser.php | 管理员 | 可设置 | ✅ 可用 |
| **代理后台添加** | agent/suser.php | 代理商 | 受限 | ✅ 可用 |

#### 2. 代理与普通用户

⚠️ **核心问题**：
- 前台注册的用户 **全部是代理**（`ifagent=1`）
- 后台添加可以选择是否为代理

**对比表**：

| 用户类型 | 如何产生 | ifagent | maxren | 能否发展下级 |
|---------|---------|---------|--------|-------------|
| 前台注册用户 | 自助注册 | 强制=1 | 固定0 | ❌ 不能（需管理员授权） |
| 后台添加代理 | 管理员添加 | =1 | 可设置 | ✅ 能（根据maxren） |
| 后台添加普通用户 | 管理员添加 | =0 | N/A | ❌ 不能 |

#### 3. 推荐人机制

**双重标准**：

| 情况 | 推荐人来源 | 返点继承 | 代码标识 |
|------|-----------|---------|---------|
| 用户填写推荐人 | 用户输入 | ✅ 完整继承 | `$ifa=1` |
| 用户不填推荐人 | 系统默认代理（x_web.zcagent） | ❌ 清零 | `$ifa=0` |

**系统设计意图**：
- 鼓励用户填写真实推荐人（通过返点激励）
- 防止空推荐人占用系统资源

#### 4. 层级体系

```
系统架构（最多9层）：
└─ 第1层：99999999 (系统账户)
   └─ 第2层：总代理
      └─ 第3层：一级代理
         └─ 第4层：二级代理
            └─ 第5层：会员
               └─ 第6层：会员的下级
                  └─ ...最多到第9层
```

**字段设计**：
- `layer`：当前层级
- `fid`：直属上级
- `fid1~fid8`：各层级上级ID（用于快速查询整条链）

---

### 📌 优先改进建议

| 优先级 | 改进项 | 预估工作量 | 风险降低 |
|-------|-------|-----------|---------|
| 🔴 **极高** | 修改前台注册 `ifagent` 默认值为0 | 🟢 1小时 | 消除代理泛滥风险 |
| 🔴 **极高** | 密码加密升级（MD5 → bcrypt） | 🟡 2天 | 防止密码泄露 |
| 🔴 **高** | 增加注册审核机制（邮箱/手机验证） | 🟡 3天 | 防止批量注册 |
| 🟡 **中** | 增加注册开关配置 | 🟢 30分钟 | 应急响应能力 |
| 🟡 **中** | 完善推荐人验证（状态、层级检查） | 🟢 1小时 | 防止异常推荐关系 |
| 🟡 **中** | 增加注册频率限制（IP/手机号） | 🟡 2小时 | 防止恶意注册 |
| 🟢 **低** | 升级验证码（reCAPTCHA） | 🟡 4小时 | 防止机器注册 |
| 🟢 **低** | 增加用户协议确认 | 🟢 30分钟 | 合规性 |

---

### 🎯 核心改进代码示例

#### 改进 1：修改默认 ifagent

```php
// 文件：uxj/reg.php 第76行
// 修改前：
$sql = "insert into `$tb_user` set ...ifagent='1'...";

// 修改后：
$sql = "insert into `$tb_user` set ...ifagent='0'...";  // 默认为普通用户
```

#### 改进 2：增加注册开关

```php
// 文件：uxj/reg.php 开头增加
$msql->query("select allow_register from `$tb_config`");
$msql->next_record();
if ($msql->f('allow_register') != 1) {
    echo "<script>alert('系统维护中，暂停注册！');</script>";
    exit;
}
```

#### 改进 3：增强推荐人验证

```php
// 文件：uxj/reg.php 第39-48行 替换为
if($forms->isName($agent)){
    $msql->query("select username,status,layer,ifagent from `$tb_user`
                  where username='$agent' and wid='$wid'");
    $msql->next_record();

    // 检查推荐人是否存在
    if($msql->f('username')!=$agent){
        echo "<script language='javascript'>alert('推荐人不存在!');</script>";
        exit;
    }

    // 检查推荐人状态
    if($msql->f('status') != 1){
        echo "<script language='javascript'>alert('推荐人账户已被禁用!');</script>";
        exit;
    }

    // 检查推荐人是否是代理
    if($msql->f('ifagent') != 1){
        echo "<script language='javascript'>alert('该用户不是代理，无法作为推荐人!');</script>";
        exit;
    }

    // 检查层级深度
    if($msql->f('layer') >= 8){
        echo "<script language='javascript'>alert('推荐人层级已达上限!');</script>";
        exit;
    }

    $trueagent=$msql->f('username');
}
```

---

### 📊 数据统计建议

为了更好地了解注册情况，建议增加以下统计报表：

1. **注册来源统计**
   ```sql
   SELECT
       DATE(regtime) as date,
       COUNT(*) as total,
       SUM(CASE WHEN fid=(SELECT zcagent FROM x_web WHERE wid=103) THEN 1 ELSE 0 END) as from_default,
       SUM(CASE WHEN fid!=(SELECT zcagent FROM x_web WHERE wid=103) THEN 1 ELSE 0 END) as from_refer
   FROM x_user
   WHERE regtime >= DATE_SUB(NOW(), INTERVAL 30 DAY)
   GROUP BY DATE(regtime);
   ```

2. **代理发展统计**
   ```sql
   SELECT
       u1.username as agent_name,
       u1.layer,
       COUNT(u2.userid) as total_members,
       SUM(u2.kmoney) as total_balance
   FROM x_user u1
   LEFT JOIN x_user u2 ON u1.userid = u2.fid
   WHERE u1.ifagent = 1
   GROUP BY u1.userid
   ORDER BY total_members DESC
   LIMIT 20;
   ```

3. **层级分布统计**
   ```sql
   SELECT
       layer,
       COUNT(*) as count,
       AVG(kmoney) as avg_balance,
       SUM(kmoney) as total_balance
   FROM x_user
   GROUP BY layer
   ORDER BY layer;
   ```

---

## 附录

### A. 相关文件列表

| 文件路径 | 功能 | 行数 |
|---------|------|------|
| `uxj/reg.php` | PC端注册页面 | 277行 |
| `mxj/reg.php` | 移动端注册页面 | 310行 |
| `hide/suser.php` | 管理员用户管理 | 663行+ |
| `agent/suser.php` | 代理用户管理 | - |
| `data/db.php` | 数据表定义 | - |
| `func/func.php` | 通用函数（setupid等） | - |

### B. 数据库表结构

```sql
-- x_user 表（简化版）
CREATE TABLE `x_user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `userid` varchar(8) NOT NULL,
  `username` varchar(32) NOT NULL,
  `userpass` varchar(32) NOT NULL,
  `name` varchar(50) DEFAULT NULL,
  `tel` varchar(20) DEFAULT NULL,
  `qq` varchar(30) DEFAULT NULL,
  `ifagent` tinyint(1) DEFAULT '0',
  `layer` int(11) DEFAULT '1',
  `maxren` int(11) DEFAULT '0',
  `fid` varchar(8) DEFAULT NULL,
  `fid1` varchar(8) DEFAULT NULL,
  `fid2` varchar(8) DEFAULT NULL,
  `fid3` varchar(8) DEFAULT NULL,
  `fid4` varchar(8) DEFAULT NULL,
  `fid5` varchar(8) DEFAULT NULL,
  `fid6` varchar(8) DEFAULT NULL,
  `fid7` varchar(8) DEFAULT NULL,
  `fid8` varchar(8) DEFAULT NULL,
  `wid` int(11) DEFAULT NULL,
  `gid` int(11) DEFAULT NULL,
  `status` tinyint(1) DEFAULT '1',
  `fudong` tinyint(1) DEFAULT '1',
  `maxmoney` decimal(10,2) DEFAULT '0.00',
  `kmaxmoney` decimal(10,2) DEFAULT '0.00',
  `money` decimal(10,2) DEFAULT '0.00',
  `kmoney` decimal(10,2) DEFAULT '0.00',
  `regtime` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `userid` (`userid`),
  UNIQUE KEY `username` (`username`),
  KEY `fid` (`fid`),
  KEY `wid` (`wid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- x_web 表（站点配置）
CREATE TABLE `x_web` (
  `wid` int(11) NOT NULL,
  `zcagent` varchar(32) DEFAULT NULL COMMENT '默认注册代理',
  `guser` text COMMENT '游客账号列表',
  `uskin` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`wid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

### C. 测试用例

#### 测试用例 1：前台注册（填写推荐人）

```
前置条件：
- 推荐人账号：AGENT001（layer=2, status=1, ifagent=1）

执行步骤：
1. 访问 uxj/reg.php?agent=AGENT001
2. 填写注册信息
3. 提交表单

预期结果：
- 新用户 ifagent=1
- 新用户 layer=3
- 新用户 fid=AGENT001的userid
- 新用户继承 AGENT001 的返点设置
```

#### 测试用例 2：前台注册（不填推荐人）

```
前置条件：
- 系统默认代理（x_web.zcagent）：DEFAULT_AGENT

执行步骤：
1. 访问 uxj/reg.php
2. 推荐人留空
3. 填写其他信息提交

预期结果：
- 新用户 fid=DEFAULT_AGENT的userid
- 新用户返点被清零（a=0,b=0,c=0,d=0）
```

#### 测试用例 3：后台添加代理

```
前置条件：
- 管理员登录

执行步骤：
1. 访问 hide/suser.php
2. 选择 case="add"
3. 填写用户信息，设置 ifagent=1, maxren=10, kmaxmoney=10000

预期结果：
- 新用户可以登录代理后台
- 新用户可以添加 10 个下级
- 新用户快开彩额度为 10000
```

---

**文档结束**

> 如有疑问或需要进一步说明，请联系技术团队。
