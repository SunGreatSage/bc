{+include file='header2.html'+}
</head>
<link href="/default/css/control.css" rel="stylesheet" />
<link href="/default/css/Site.css" rel="stylesheet" />
<link href="/default/css/jquery.loadmask.css" rel="stylesheet" />
<script src="/js/jquery.loadmask.js"></script>
<script src="/js/sitetool.js"></script>
<style>
body {
    font-family: Arial, "Microsoft YaHei", sans-serif;
    font-size: 12px;
}

.jt-container {
    padding: 10px;
}

.top_info {
    background: linear-gradient(to bottom, #f5f5f5, #e5e5e5);
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    margin-bottom: 10px;
}

.title {
    font-size: 16px;
    font-weight: bold;
    color: #333;
}

.filter-panel {
    background: #fff;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 15px;
}

.filter-row {
    margin-bottom: 10px;
}

.filter-row label {
    display: inline-block;
    width: 80px;
    text-align: right;
    margin-right: 10px;
    font-weight: bold;
}

.filter-row input, .filter-row select {
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
}

.btn {
    padding: 6px 15px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    margin-right: 5px;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-info:hover {
    background: #138496;
}

.list {
    width: 100%;
    border-collapse: collapse;
}

.list th {
    background: #f0f0f0;
    padding: 10px;
    border: 1px solid #ddd;
    text-align: center;
    font-weight: bold;
}

.list td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: center;
}

.list tbody tr:hover {
    background: #f5f5f5;
}

.badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
}

.badge-success {
    background: #28a745;
    color: white;
}

.badge-danger {
    background: #dc3545;
    color: white;
}

.badge-warning {
    background: #ffc107;
    color: #333;
}

.badge-info {
    background: #17a2b8;
    color: white;
}

.text-success {
    color: #28a745;
    font-weight: bold;
}

.text-danger {
    color: #dc3545;
    font-weight: bold;
}

.text-muted {
    color: #6c757d;
}

.pagination {
    text-align: center;
    padding: 15px;
}

.pagination a, .pagination span {
    padding: 5px 10px;
    margin: 0 2px;
    border: 1px solid #ddd;
    display: inline-block;
    text-decoration: none;
}

.pagination a:hover {
    background: #007bff;
    color: white;
}

.pagination .current {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.config-panel {
    background: #fffacd;
    padding: 15px;
    border: 1px solid #ffeb3b;
    border-radius: 5px;
    margin-bottom: 15px;
}

.status-enabled {
    color: #28a745;
    font-weight: bold;
}

.status-disabled {
    color: #dc3545;
    font-weight: bold;
}
</style>

<body>
<div class="jt-container">
    <div class="top_info">
        <span class="title">最佳控盘计划</span>
        <span class="right">
            <button class="btn btn-info" onclick="location.href='best_plan.php?xtype=show'">刷新</button>
        </span>
    </div>

    <!-- 当前未开奖期次 -->
    {+if $current_qishu+}
    <div class="config-panel">
        <strong>当前未开奖期次：</strong>
        <span style="font-size: 14px; color: #007bff; font-weight: bold;">{+$current_qishu.qishu+}</span>
        &nbsp;&nbsp;|&nbsp;&nbsp;
        <strong>开奖时间：</strong>
        <span>{+$current_qishu.dates+} {+$current_qishu.endtime+}</span>
        &nbsp;&nbsp;
        <button class="btn btn-success" onclick="analyzeNow('{+$current_qishu.qishu+}')">立即分析</button>
    </div>
    {+/if+}

    <!-- 系统配置 -->
    <div class="config-panel">
        <strong>系统配置：</strong>
        功能状态：
        {+if $config.enabled == 1+}
            <span class="status-enabled">已启用</span>
        {+else+}
            <span class="status-disabled">已禁用</span>
        {+/if+}
        &nbsp;&nbsp;|&nbsp;&nbsp;
        分析时间：开奖前 <strong>{+$config.analyze_time_before+}</strong> 分钟
        &nbsp;&nbsp;|&nbsp;&nbsp;
        分析深度：<strong>{+$config.analyze_depth+}</strong>
        &nbsp;&nbsp;|&nbsp;&nbsp;
        自动分析：
        {+if $config.auto_analyze == 1+}
            <span class="status-enabled">开启</span>
        {+else+}
            <span class="status-disabled">关闭</span>
        {+/if+}
        &nbsp;&nbsp;
        <button class="btn btn-info" onclick="showConfigModal()">修改配置</button>
    </div>

    <!-- 筛选条件 -->
    <div class="filter-panel">
        <form method="get" action="best_plan.php">
            <input type="hidden" name="xtype" value="show">
            <input type="hidden" name="gid" value="{+$gid+}">

            <div class="filter-row">
                <label>开始日期：</label>
                <input type="date" name="start_date" value="{+$start_date+}">

                <label style="margin-left: 20px;">结束日期：</label>
                <input type="date" name="end_date" value="{+$end_date+}">

                <button type="submit" class="btn btn-primary">查询</button>
                <button type="button" class="btn btn-info" onclick="location.href='best_plan.php?xtype=show&gid={+$gid+}'">重置</button>
            </div>
        </form>
    </div>

    <!-- 列表 -->
    <div class="s_main">
        <table class="list">
            <thead>
                <tr>
                    <th width="5%">ID</th>
                    <th width="10%">期数</th>
                    <th width="10%">分析时间</th>
                    <th width="10%">总投注额</th>
                    <th width="10%">最大盈利</th>
                    <th width="10%">最小盈利</th>
                    <th width="8%">盈利差</th>
                    <th width="12%">最佳号码</th>
                    <th width="12%">最差号码</th>
                    <th width="8%">开奖结果</th>
                    <th width="15%">操作</th>
                </tr>
            </thead>
            <tbody>
                {+if $list+}
                {+section name=i loop=$list+}
                <tr>
                    <td>{+$list[i].id+}</td>
                    <td><strong>{+$list[i].qishu+}</strong></td>
                    <td>{+$list[i].analyze_time+}</td>
                    <td>{+$list[i].total_bet_amount_fmt+}</td>
                    <td class="text-success">
                        {+$list[i].max_profit_fmt+}
                        <br>
                        <small>({+$list[i].max_profit_rate+}%)</small>
                    </td>
                    <td class="text-danger">
                        {+$list[i].min_profit_fmt+}
                        <br>
                        <small>({+$list[i].min_profit_rate+}%)</small>
                    </td>
                    <td>
                        {+$list[i].profit_range_fmt+}
                    </td>
                    <td>
                        <span class="badge badge-success">{+$list[i].best_numbers+}</span>
                    </td>
                    <td>
                        <span class="badge badge-danger">{+$list[i].worst_numbers+}</span>
                    </td>
                    <td>
                        {+if $list[i].is_opened+}
                            {+if $list[i].result_in_best+}
                                <span class="badge badge-success">{+$list[i].result+} ✓</span>
                            {+else+}
                                <span class="badge badge-warning">{+$list[i].result+}</span>
                            {+/if+}
                        {+else+}
                            <span class="text-muted">未开奖</span>
                        {+/if+}
                    </td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewDetail('{+$list[i].qishu+}')">查看详情</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePlan({+$list[i].id+})">删除</button>
                    </td>
                </tr>
                {+/section+}
                {+else+}
                <tr>
                    <td colspan="11" style="text-align:center; padding:20px;">
                        <span class="text-muted">暂无数据</span>
                    </td>
                </tr>
                {+/if+}
            </tbody>
        </table>

        <!-- 分页 -->
        {+if $total_pages > 1+}
        <div class="pagination">
            {+if $page_num > 1+}
                <a href="best_plan.php?xtype=show&gid={+$gid+}&start_date={+$start_date+}&end_date={+$end_date+}&page={+$page_num-1+}">上一页</a>
            {+/if+}

            {+section name=p start=1 loop=$total_pages+1+}
                {+if $smarty.section.p.index == $page_num+}
                    <span class="current">{+$smarty.section.p.index+}</span>
                {+else+}
                    <a href="best_plan.php?xtype=show&gid={+$gid+}&start_date={+$start_date+}&end_date={+$end_date+}&page={+$smarty.section.p.index+}">{+$smarty.section.p.index+}</a>
                {+/if+}
            {+/section+}

            {+if $page_num < $total_pages+}
                <a href="best_plan.php?xtype=show&gid={+$gid+}&start_date={+$start_date+}&end_date={+$end_date+}&page={+$page_num+1+}">下一页</a>
            {+/if+}

            <span style="margin-left: 20px;">共 {+$total+} 条记录，共 {+$total_pages+} 页</span>
        </div>
        {+/if+}
    </div>
</div>

<!-- 配置修改弹窗 -->
<div id="configModal" style="display:none; position:fixed; top:20%; left:30%; width:40%; background:#fff; border:2px solid #007bff; border-radius:5px; padding:20px; z-index:9999;">
    <h3 style="margin-top:0;">系统配置</h3>
    <div style="margin-bottom:15px;">
        <label style="display:inline-block; width:120px;">功能状态：</label>
        <select id="config_enabled" style="padding:5px;">
            <option value="1">启用</option>
            <option value="0">禁用</option>
        </select>
    </div>
    <div style="margin-bottom:15px;">
        <label style="display:inline-block; width:120px;">分析时间（分钟）：</label>
        <input type="number" id="config_analyze_time_before" style="padding:5px; width:100px;" min="1" max="60">
    </div>
    <div style="margin-bottom:15px;">
        <label style="display:inline-block; width:120px;">分析深度：</label>
        <select id="config_analyze_depth" style="padding:5px;">
            <option value="full">全量分析</option>
            <option value="hot">热门号</option>
        </select>
    </div>
    <div style="margin-bottom:15px;">
        <label style="display:inline-block; width:120px;">自动分析：</label>
        <select id="config_auto_analyze" style="padding:5px;">
            <option value="1">开启</option>
            <option value="0">关闭</option>
        </select>
    </div>
    <div style="text-align:center;">
        <button class="btn btn-primary" onclick="saveConfig()">保存</button>
        <button class="btn" onclick="hideConfigModal()">取消</button>
    </div>
</div>
<div id="configModalMask" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9998;"></div>

<script>
// 查看详情
function viewDetail(qishu) {
    window.location.href = 'best_plan.php?xtype=detail&qishu=' + qishu + '&gid={+$gid+}';
}

// 立即分析
function analyzeNow(qishu) {
    if (!confirm('确定要立即分析期次 ' + qishu + ' 吗？')) {
        return;
    }

    $.ajax({
        url: 'best_plan.php?xtype=analyze_now',
        type: 'POST',
        data: {
            qishu: qishu,
            gid: '{+$gid+}'
        },
        dataType: 'json',
        success: function(res) {
            if (res.success) {
                alert('分析成功！\n\n期数：' + res.data.qishu + '\n总投注额：' + res.data.total_bet_amount + '\n最大盈利：' + res.data.max_profit + '\n最小盈利：' + res.data.min_profit + '\n最佳号码：' + res.data.best_numbers.join(',') + '\n最差号码：' + res.data.worst_numbers.join(','));
                location.reload();
            } else {
                alert('分析失败：' + res.message);
            }
        },
        error: function() {
            alert('请求失败，请重试');
        }
    });
}

// 删除计划
function deletePlan(id) {
    if (!confirm('确定要删除这条分析记录吗？')) {
        return;
    }

    $.ajax({
        url: 'best_plan.php?xtype=delete',
        type: 'POST',
        data: {
            id: id
        },
        dataType: 'json',
        success: function(res) {
            if (res.success) {
                alert('删除成功');
                location.reload();
            } else {
                alert('删除失败：' + res.message);
            }
        },
        error: function() {
            alert('请求失败，请重试');
        }
    });
}

// 显示配置弹窗
function showConfigModal() {
    $('#config_enabled').val('{+$config.enabled+}');
    $('#config_analyze_time_before').val('{+$config.analyze_time_before+}');
    $('#config_analyze_depth').val('{+$config.analyze_depth+}');
    $('#config_auto_analyze').val('{+$config.auto_analyze+}');

    $('#configModal').show();
    $('#configModalMask').show();
}

// 隐藏配置弹窗
function hideConfigModal() {
    $('#configModal').hide();
    $('#configModalMask').hide();
}

// 保存配置
function saveConfig() {
    $.ajax({
        url: 'best_plan.php?xtype=config_save',
        type: 'POST',
        data: {
            enabled: $('#config_enabled').val(),
            analyze_time_before: $('#config_analyze_time_before').val(),
            analyze_depth: $('#config_analyze_depth').val(),
            auto_analyze: $('#config_auto_analyze').val()
        },
        dataType: 'json',
        success: function(res) {
            if (res.success) {
                alert('配置保存成功');
                location.reload();
            } else {
                alert('配置保存失败：' + res.message);
            }
        },
        error: function() {
            alert('请求失败，请重试');
        }
    });
}
</script>
</body>
</html>
